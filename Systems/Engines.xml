<?xml version="1.0"?>
<system name="Engines">
    <!-- NOTES: -->
    <!--
        Required BHP for idling at 500 rpm: ~11
        Blower can maintain 48 inHg MP up to 7000 ft pressure altitude;
        corresponding atmospheric pressure is 23.09 inHg. Ergo, the blower
        can achieve up to 24.91 inHg of additional pressure.
    -->

    <!--

    Engine Controls:
    ================

    - THROTTLE: /controls/engines/engine[n]/throttle
      Directly controls the throttle valve on the carburetor.
    - MIXTURE: /controls/engines/engine[n]/mixture
      Controls the automatic mixture setting, ranging between:
      0.000 - cutoff
      0.125 - auto lean
      0.875 - auto rich
      1.000 - full rich
    - STARTER: /controls/engines/engine[n]/starter
    - MAGNETOS: /controls/engines/engine[n]/magnetos
    - PRIMER: /controls/engines/engine[n]/primer [add this]
    - BOOST COIL: /controls/engines/engine[n]/boost-coil [add this]

    Engine State:
    =============

    - FIRING: propulsion/engine[n]/firing
      The engine will fire when the following conditions are met:
      - FUEL is available to the engine, either as primed fuel, or from the
        carburetor. The carburetor will deliver fuel if the following
        conditions are met:
            1. mixture control is at least in the "AUTO LEAN" position
            2. engine RPM is at least 450 rpm (just below idle), OR boost pump
               is on and engine RPM is at least 250 rpm (wild guess).
      - SPARK is available, either from the boost coil, or from the magnetos.
    - PRIMED FUEL: propulsion/engine[n]/primed-fuel
      The amount of fuel available to the engine through priming. This number
      will increase with each priming stroke, and decrease as the engine fires.
    - CYLINDER HEAT: propulsion/engine[n]/cht-k
      Influenced by fuel flow (= fuel burn), cowl flap state, airspeed, OAT.
      Influences effective engine power; exceeding max CHT will cause an engine
      fire.

    -->

    <channel name="Atmosphere">
        <fcs_function name="atmosphere/P-inhg">
            <function>
                <product>
                    <p>atmosphere/P-psf</p>
                    <!-- convert to inHg -->
                    <v>0.014139032344453</v>
                </product>
            </function>
        </fcs_function>
    </channel>

    <channel name="Cowl Flaps">
        <!-- actual lever positions are:
               4 = close
               3 = off
               2 = trail
               1 = off
               0 = open
        -->
        <switch name="propulsion/engine[0]/cowl-flaps-cmd">
            <default value="propulsion/engine[0]/cowl-flaps" />
            <test logic="AND" value="1.0">
                /controls/engines/engine[0]/cowl-flaps-cmd lt 0.5
            </test>
            <test logic="AND" value="0.5">
                /controls/engines/engine[0]/cowl-flaps-cmd gt 1.5
                /controls/engines/engine[0]/cowl-flaps-cmd lt 2.5
            </test>
            <test logic="AND" value="0.0">
                /controls/engines/engine[0]/cowl-flaps-cmd gt 3.5
            </test>
        </switch>

        <actuator name="propulsion/engine[0]/cowl-flaps">
            <input>propulsion/engine[0]/cowl-flaps-cmd</input>
            <rate_limit>0.125</rate_limit>
        </actuator>

        <actuator name="/controls/engines/engine[0]/cowl-flaps-pos">
            <input>/controls/engines/engine[0]/cowl-flaps-cmd</input>
            <rate_limit>4</rate_limit>
        </actuator>

        <pure_gain name="/controls/engines/engine[0]/cowl-flaps-norm">
            <input>propulsion/engine[0]/cowl-flaps</input>
            <gain>1.0</gain>
        </pure_gain>

        <switch name="propulsion/engine[1]/cowl-flaps-cmd">
            <default value="propulsion/engine[1]/cowl-flaps" />
            <test logic="AND" value="1.0">
                /controls/engines/engine[1]/cowl-flaps-cmd lt 0.5
            </test>
            <test logic="AND" value="0.5">
                /controls/engines/engine[1]/cowl-flaps-cmd gt 1.5
                /controls/engines/engine[1]/cowl-flaps-cmd lt 2.5
            </test>
            <test logic="AND" value="0.0">
                /controls/engines/engine[1]/cowl-flaps-cmd gt 3.5
            </test>
        </switch>

        <actuator name="propulsion/engine[1]/cowl-flaps">
            <input>propulsion/engine[1]/cowl-flaps-cmd</input>
            <rate_limit>0.125</rate_limit>
        </actuator>

        <actuator name="/controls/engines/engine[1]/cowl-flaps-pos">
            <input>/controls/engines/engine[1]/cowl-flaps-cmd</input>
            <rate_limit>4</rate_limit>
        </actuator>

        <pure_gain name="/controls/engines/engine[1]/cowl-flaps-norm">
            <input>propulsion/engine[1]/cowl-flaps</input>
            <gain>1.0</gain>
        </pure_gain>
    </channel>

    <channel name="Left Engine">
        <pure_gain name="/engines/engine[0]/cyl-temp">
            <input>propulsion/engine[0]/cht-degc</input>
            <gain>1</gain>
        </pure_gain>

        <fcs_function name="propulsion/engine[0]/heat-production">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine[0]/power-hp-target</independentVar>
                    <tableData>
                         0 0
                        <!-- this should be enough to keep CHT around 120°C when idling at 500 rpm with a warm engine. -->
                         9 0.650
                        <!-- engine warm-up: 1000 rpm stationary, this amounts to about 50 BHP. -->
                        <!-- warm-up takes about 3-5 minutes (300 seconds) from 20°C to 100-120°C -->
                        50 1.000
                        <!-- remaining values are guesswork -->
                       150 1.500
                       600 2.000
                      1050 4.000
                      1200 4.500
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[0]/heat-difference">
            <function>
                <difference>
                    <sum>
                        <quotient>
                            <p>atmosphere/T-R</p>
                            <!-- convert Rankine to Kelvin -->
                            <v>1.8</v>
                        </quotient>
                        <!-- convert Kelvin to Celsius -->
                        <v>-273.15</v>
                    </sum>
                    <p>propulsion/engine[0]/cht-degc</p>
                </difference>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[0]/heat-shedding-factor">
            <function>
                <table>
                    <independentVar lookup="column">aero/qbar-psf</independentVar>
                    <independentVar lookup="row">propulsion/engine[0]/cowl-flaps</independentVar>
                    <!-- key figures: -->
                    <!--
                    - takeoff: cowl flaps wide open, 1200 BHP, temperature reaches 260°C within 5 minutes.
                        heat prod: 7.2
                        typical temp diff: 240°C
                    - max cont: cowl flaps wide open, 1050 BHP, temperature stabilizes at 230°C.
                        heat prod: 6.3
                        typical temp diff: 210°C
                        qbar-psf: 30-60 (airspeed 75-150 knots)
                    - cruise: cowl flaps closed, 625 BHP, temperature stabilizes at 200°C.
                    - taxi: cowl flaps open, 50-500 BHP (avg), temperature limit 200°C, typical 180°C
                        heat prod: 0.3 - 3.0, avg 1.6
                        typical temp diff: 160°C
                        qbar-psf: 0
                    -->
                    <tableData>
                              0      30    60    75
                        0     0.001  0.009 0.011 0.012
                        0.5   0.002  0.013 0.014 0.015
                        1     0.008  0.016 0.017 0.018
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[0]/heat-loss">
            <function>
                <product>
                    <p>propulsion/engine[0]/heat-shedding-factor</p>
                    <p>propulsion/engine[0]/heat-difference</p>
                </product>
            </function>
        </fcs_function>
        
        <fcs_function name="propulsion/engine[0]/cht-degc">
            <function>
                <sum>
                    <p>propulsion/engine[0]/cht-degc</p>
                    <product>
						<p>simulation/channel-dt</p>
                        <sum>
                            <p>propulsion/engine[0]/heat-production</p>
                            <p>propulsion/engine[0]/heat-loss</p>
                        </sum>
                    </product>
                </sum>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[0]/suction-inhg">
            <function>
                <sum>
                    <product>
                        <v>30</v>
                        <pow>
                            <v>0.5</v>
                            <product>
                                <p>propulsion/engine[0]/engine-rpm</p>
                                <v>0.02222222222222222222</v>
                            </product>
                        </pow>
                    </product>
                    <value>-30</value>
                </sum>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[0]/blower-inhg">
            <function>
                <sum>
                    <product>
                        <v>-20</v>
                        <pow>
                            <v>0.5</v>
                            <product>
                                <p>propulsion/engine[0]/engine-rpm</p>
                                <v>0.002222222222222222222</v>
                            </product>
                        </pow>
                    </product>
                    <product>
                        <p>propulsion/engine[0]/engine-rpm</p>
                        <v>0.013</v>
                    </product>
                    <value>20</value>
                </sum>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[0]/mp-min-inhg">
            <function>
                <sum>
                    <p>atmosphere/P-inhg</p>
                    <p>propulsion/engine[0]/suction-inhg</p>
                </sum>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[0]/mp-max-inhg">
            <function>
                <sum>
                    <p>atmosphere/P-inhg</p>
                    <p>propulsion/engine[0]/suction-inhg</p>
                    <p>propulsion/engine[0]/blower-inhg</p>
                </sum>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[0]/mp-inhg">
            <function>
                <sum>
                    <product>
                        <p>/controls/engines/engine[0]/throttle</p>
                        <difference>
                            <p>propulsion/engine[0]/mp-max-inhg</p>
                            <p>propulsion/engine[0]/mp-min-inhg</p>
                        </difference>
                    </product>
                    <p>propulsion/engine[0]/mp-min-inhg</p>
                </sum>
            </function>
        </fcs_function>

        <!-- max power attainable at sea level, mixture auto rich -->
        <fcs_function name="propulsion/engine[0]/power-hp-sl">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine[0]/engine-rpm</independentVar>
                    <independentVar lookup="column">propulsion/engine[0]/mp-inhg</independentVar>
                    <tableData>
                                0     10    15    20    26    28    30    32    34    36    38    40    42    44    46    48
                           0    0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0
                          30    0.1   0.1   0.1   0.1   0.1   0.1   0.1   0.1   0.1   0.1   0.1   0.1   0.1   0.1   0.1   0.1 
                         400    3.2   10    21    32    50    54    60    65    70    75    80    85    90    95    100   105
                         600    10    25    70    80    123   135   150   163   175   183   200   213   225   238   250   263
                        1000    30    100   140   180   245   270   300   325   350   375   400   425   450   475   500   525
                        2000    50    150   210   300   490   540   600   650   700   750   800   850   900   950   1000  1050
                        2200    70    180   250   330   525   580   640   710   770   820   870   920   960   1000  1050  1100
                        2400    100   200   265   350   540   610   675   740   800   860   915   965   1005  1050  1095  1135
                        2550    140   220   280   370   575   640   700   765   825   885   935   985   1030  1075  1125  1175
                        2700    190   240   295   380   595   660   725   790   850   915   965   1020  1070  1115  1160  1200
                        2750    220   300   340   390   580   675   740   805   835   935   985   1040  1090  1135  1180  1220
                        2800    230   310   350   400   610   690   755   820   850   955   1005  1060  1110  1155  1200  1240
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <!-- power needed to crank the engine to 20 rpm -->
        <fcs_function name="propulsion/engine[0]/power-hp-starter">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine[0]/engine-rpm</independentVar>
                    <independentVar lookup="column">/controls/engines/engine[0]/starter</independentVar>
                    <tableData>
                             0      1
                         0   0      0.015
                         5   -0.05  0.015
                        25   -0.25  0.005
                        30   -0.3   0.002
                        35   -0.35  -0.001
                        40   -0.4   -0.055
                       100   -1     -1
                      1000   -100   -100
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[0]/power-hp-firing">
            <function>
                <product>
                    <p>propulsion/engine[0]/power-hp-sl</p>
                    <table>
                        <independentVar lookup="row">atmosphere/pressure-altitude</independentVar>
                        <tableData>
                            -2000   1.0000
                                0   1.0000
                             1000   1.0010
                             2000   1.0025
                             3000   1.0050
                             4000   1.0090
                             5000   1.0160
                             6000   1.0250
                             8000   1.0450
                            11000   1.0810
                            15000   1.1300
                            20000   1.2000
                        </tableData>
                    </table>
                </product>
            </function>
        </fcs_function>

        <pure_gain name="propulsion/engine[0]/power-hp-backfiring">
            <!-- good enough for now -->
            <input>propulsion/engine[0]/power-hp-firing</input>
            <gain>0.25</gain>
        </pure_gain>

        <switch name="propulsion/engine[0]/has-spark">
            <default value="0" />
            <test logic="OR" value="1">
                <test>
                    /controls/engines/engine[0]/boost-coil gt 0
                </test>
                <test logic="AND">
                    /controls/engines/engine[0]/magnetos gt 0
                    propulsion/engine[0]/engine-rpm gt 300
                </test>
            </test>
        </switch>

        <fcs_function name="propulsion/engine[0]/backfiring-rpm-limit">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine[0]/cht-degc</independentVar>
                    <tableData>
                        -10  800
                          0  900
                         10 1000
                         80 2000
                         90 2600
                        100 2700
                        120 2900
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <switch name="propulsion/engine[0]/backfiring">
            <default value="0"/>
            <test logic="AND" value="1">
                <test logic="OR" value="1">
                    <!-- running too hard when cold -->
                    propulsion/engine[0]/engine-rpm gt propulsion/engine[0]/backfiring-rpm-limit
                    <!-- too much fuel in engine (overprimed) -->
                    propulsion/engine[0]/fuel-available gt 5
                </test>
                <test logic="AND" value="1">
                    propulsion/engine[0]/has-spark gt 0
                    propulsion/engine[0]/fuel-available gt 0.1
                    propulsion/engine[0]/engine-rpm gt 30
                </test>
            </test>
        </switch>

        <fcs_function name="propulsion/engine[0]/backfiring-event">
            <function>
                <product>
                    <gt>
                        <product>
                            <sum>
                                <urandom/>
                                <v>1.0</v>
                            </sum>
                            <v>0.5</v>
                        </product>
                        <p>params/misc/backfiring-frequency</p>
                    </gt>
                    <p>propulsion/engine[0]/backfiring</p>
                </product>
            </function>
        </fcs_function>

        <switch name="propulsion/engine[0]/firing-state">
            <default value="0" />
            <!-- backfiring -->
            <test logic="OR" value="2">
                propulsion/engine[0]/backfiring gt 0
            </test>
            <test logic="AND" value="1">
                propulsion/engine[0]/has-spark gt 0
                propulsion/engine[0]/engine-rpm gt 30
                propulsion/engine[0]/fuel-available gt 0.1
            </test>
        </switch>

        <switch name="propulsion/engine[0]/power-hp-target">
            <default value="propulsion/engine[0]/power-hp-starter" />
            <test logic="OR" value="propulsion/engine[0]/power-hp-firing">
                propulsion/engine[0]/firing-state eq 1
            </test>
            <test logic="OR" value="propulsion/engine[0]/power-hp-backfiring">
                propulsion/engine[0]/firing-state eq 2
            </test>
        </switch>

        <pure_gain name="/engines/engine[0]/mp-osi">
            <input>propulsion/engine[0]/mp-inhg</input>
            <gain>1</gain>
        </pure_gain>

        <fcs_function name="fcs/throttle-pos-norm[0]">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine[0]/power-hp-target</independentVar>
                    <tableData>
                        0  0
                     1200  1
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[0]/fuel-demand-firing">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine[0]/power-hp-firing</independentVar>
                    <tableData>
                         0   0.2
                       625   7.5
                      1200  15.0
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[0]/fuel-demand-cranking">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine[0]/engine-rpm</independentVar>
                    <tableData>
                         0   0.0
                        30   0.1
                      1000   1.0
                      3000   3.0
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <switch name="propulsion/engine[0]/fuel-demand">
            <default value="propulsion/engine[0]/fuel-demand-cranking"/>
            <test value="propulsion/engine[0]/fuel-demand-firing">
                propulsion/engine[0]/firing-state eq 1
            </test>
        </switch>

        <fcs_function name="propulsion/engine[0]/max-fuel-flow">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine[0]/engine-rpm</independentVar>
                    <tableData>
                          0   0.0
                        150   0.0
                        500   1.0
                       1000  10.0
                       2000  20.0
                       3000  30.0
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <pure_gain name="propulsion/engine[0]/fuel-flow-primer">
            <input>/controls/engines/engine[0]/primer</input>
            <gain>1.0</gain>
        </pure_gain>

        <fcs_function name="propulsion/engine[0]/fuel-flow">
            <function>
                <difference>
                    <sum>
                        <!-- fuel supply from carburetor -->
                        <min>
                            <table>
                                <independentVar lookup="row">propulsion/engine[0]/fuel-available</independentVar>
                                <tableData>
                                   0.0  30
                                   0.5   0
                                </tableData>
                            </table>
                            <p>propulsion/engine[0]/max-fuel-flow</p>
                        </min>
                        <p>propulsion/engine[0]/fuel-flow-primer</p>
                    </sum>
                    <!-- fuel out -->
                    <p>propulsion/engine[0]/fuel-demand</p>
                </difference>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[0]/fuel-available">
            <function>
                <max>
                    <sum>
                        <p>propulsion/engine[0]/fuel-available</p>
                        <product>
                            <p>simulation/channel-dt</p>
                            <p>propulsion/engine[0]/fuel-flow</p>
                        </product>
                    </sum>
                    <v>0.0</v>
                </max>
            </function>
        </fcs_function>

    </channel>

    <channel name="Right Engine">
        <pure_gain name="/engines/engine[1]/cyl-temp">
            <input>propulsion/engine[1]/cht-degc</input>
            <gain>1</gain>
        </pure_gain>

        <fcs_function name="propulsion/engine[1]/heat-production">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine[1]/power-hp-target</independentVar>
                    <tableData>
                         0 0
                        <!-- this should be enough to keep CHT around 120°C when idling at 500 rpm with a warm engine. -->
                         9 0.650
                        <!-- engine warm-up: 1000 rpm stationary, this amounts to about 50 BHP. -->
                        <!-- warm-up takes about 3-5 minutes (300 seconds) from 20°C to 100-120°C -->
                        50 1.000
                        <!-- remaining values are guesswork -->
                       150 1.500
                       600 2.000
                      1050 4.000
                      1200 4.500
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[1]/heat-difference">
            <function>
                <difference>
                    <sum>
                        <quotient>
                            <p>atmosphere/T-R</p>
                            <!-- convert Rankine to Kelvin -->
                            <v>1.8</v>
                        </quotient>
                        <!-- convert Kelvin to Celsius -->
                        <v>-273.15</v>
                    </sum>
                    <p>propulsion/engine[1]/cht-degc</p>
                </difference>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[1]/heat-shedding-factor">
            <function>
                <table>
                    <independentVar lookup="column">aero/qbar-psf</independentVar>
                    <independentVar lookup="row">propulsion/engine[1]/cowl-flaps</independentVar>
                    <!-- key figures: -->
                    <!--
                    - takeoff: cowl flaps wide open, 1200 BHP, temperature reaches 260°C within 5 minutes.
                        heat prod: 7.2
                        typical temp diff: 240°C
                    - max cont: cowl flaps wide open, 1050 BHP, temperature stabilizes at 230°C.
                        heat prod: 6.3
                        typical temp diff: 210°C
                        qbar-psf: 30-60 (airspeed 75-150 knots)
                    - cruise: cowl flaps closed, 625 BHP, temperature stabilizes at 200°C.
                    - taxi: cowl flaps open, 50-500 BHP (avg), temperature limit 200°C, typical 180°C
                        heat prod: 0.3 - 3.0, avg 1.6
                        typical temp diff: 160°C
                        qbar-psf: 0
                    -->
                    <tableData>
                              0      30    60    75
                        0     0.001  0.009 0.011 0.012
                        0.5   0.002  0.013 0.014 0.015
                        1     0.008  0.016 0.017 0.018
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[1]/heat-loss">
            <function>
                <product>
                    <p>propulsion/engine[1]/heat-shedding-factor</p>
                    <p>propulsion/engine[1]/heat-difference</p>
                </product>
            </function>
        </fcs_function>
        
        <fcs_function name="propulsion/engine[1]/cht-degc">
            <function>
                <sum>
                    <p>propulsion/engine[1]/cht-degc</p>
                    <product>
						<p>simulation/channel-dt</p>
                        <sum>
                            <p>propulsion/engine[1]/heat-production</p>
                            <p>propulsion/engine[1]/heat-loss</p>
                        </sum>
                    </product>
                </sum>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[1]/suction-inhg">
            <function>
                <sum>
                    <product>
                        <v>30</v>
                        <pow>
                            <v>0.5</v>
                            <product>
                                <p>propulsion/engine[1]/engine-rpm</p>
                                <v>0.02222222222222222222</v>
                            </product>
                        </pow>
                    </product>
                    <value>-30</value>
                </sum>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[1]/blower-inhg">
            <function>
                <sum>
                    <product>
                        <v>-20</v>
                        <pow>
                            <v>0.5</v>
                            <product>
                                <p>propulsion/engine[1]/engine-rpm</p>
                                <v>0.002222222222222222222</v>
                            </product>
                        </pow>
                    </product>
                    <product>
                        <p>propulsion/engine[1]/engine-rpm</p>
                        <v>0.013</v>
                    </product>
                    <value>20</value>
                </sum>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[1]/mp-min-inhg">
            <function>
                <sum>
                    <p>atmosphere/P-inhg</p>
                    <p>propulsion/engine[1]/suction-inhg</p>
                </sum>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[1]/mp-max-inhg">
            <function>
                <sum>
                    <p>atmosphere/P-inhg</p>
                    <p>propulsion/engine[1]/suction-inhg</p>
                    <p>propulsion/engine[1]/blower-inhg</p>
                </sum>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[1]/mp-inhg">
            <function>
                <sum>
                    <product>
                        <p>/controls/engines/engine[1]/throttle</p>
                        <difference>
                            <p>propulsion/engine[1]/mp-max-inhg</p>
                            <p>propulsion/engine[1]/mp-min-inhg</p>
                        </difference>
                    </product>
                    <p>propulsion/engine[1]/mp-min-inhg</p>
                </sum>
            </function>
        </fcs_function>

        <!-- max power attainable at sea level, mixture auto rich -->
        <fcs_function name="propulsion/engine[1]/power-hp-sl">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine[1]/engine-rpm</independentVar>
                    <independentVar lookup="column">propulsion/engine[1]/mp-inhg</independentVar>
                    <tableData>
                                0     10    15    20    26    28    30    32    34    36    38    40    42    44    46    48
                           0    0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0
                          30    0.1   0.1   0.1   0.1   0.1   0.1   0.1   0.1   0.1   0.1   0.1   0.1   0.1   0.1   0.1   0.1 
                         400    3.2   10    21    32    50    54    60    65    70    75    80    85    90    95    100   105
                         600    10    25    70    80    123   135   150   163   175   183   200   213   225   238   250   263
                        1000    30    100   140   180   245   270   300   325   350   375   400   425   450   475   500   525
                        2000    50    150   210   300   490   540   600   650   700   750   800   850   900   950   1000  1050
                        2200    70    180   250   330   525   580   640   710   770   820   870   920   960   1000  1050  1100
                        2400    100   200   265   350   540   610   675   740   800   860   915   965   1005  1050  1095  1135
                        2550    140   220   280   370   575   640   700   765   825   885   935   985   1030  1075  1125  1175
                        2700    190   240   295   380   595   660   725   790   850   915   965   1020  1070  1115  1160  1200
                        2750    220   300   340   390   580   675   740   805   835   935   985   1040  1090  1135  1180  1220
                        2800    230   310   350   400   610   690   755   820   850   955   1005  1060  1110  1155  1200  1240
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <!-- power needed to crank the engine to 20 rpm -->
        <fcs_function name="propulsion/engine[1]/power-hp-starter">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine[1]/engine-rpm</independentVar>
                    <independentVar lookup="column">/controls/engines/engine[1]/starter</independentVar>
                    <tableData>
                             0      1
                         0   0      0.015
                         5   -0.05  0.015
                        25   -0.25  0.005
                        30   -0.3   0.002
                        35   -0.35  -0.001
                        40   -0.4   -0.055
                       100   -1     -1
                      1000   -100   -100
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[1]/power-hp-firing">
            <function>
                <product>
                    <p>propulsion/engine[1]/power-hp-sl</p>
                    <table>
                        <independentVar lookup="row">atmosphere/pressure-altitude</independentVar>
                        <tableData>
                            -2000   1.0000
                                0   1.0000
                             1000   1.0010
                             2000   1.0025
                             3000   1.0050
                             4000   1.0090
                             5000   1.0160
                             6000   1.0250
                             8000   1.0450
                            11000   1.0810
                            15000   1.1300
                            20000   1.2000
                        </tableData>
                    </table>
                </product>
            </function>
        </fcs_function>

        <pure_gain name="propulsion/engine[1]/power-hp-backfiring">
            <!-- good enough for now -->
            <input>propulsion/engine[1]/power-hp-firing</input>
            <gain>0.25</gain>
        </pure_gain>

        <switch name="propulsion/engine[1]/has-spark">
            <default value="0" />
            <test logic="OR" value="1">
                <test>
                    /controls/engines/engine[1]/boost-coil gt 0
                </test>
                <test logic="AND">
                    /controls/engines/engine[1]/magnetos gt 0
                    propulsion/engine[1]/engine-rpm gt 300
                </test>
            </test>
        </switch>

        <fcs_function name="propulsion/engine[1]/backfiring-rpm-limit">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine[1]/cht-degc</independentVar>
                    <tableData>
                        -10  800
                          0  900
                         10 1000
                         80 2000
                         90 2600
                        100 2700
                        120 2900
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <switch name="propulsion/engine[1]/backfiring">
            <default value="0"/>
            <test logic="AND" value="1">
                <test logic="OR" value="1">
                    <!-- running too hard when cold -->
                    propulsion/engine[1]/engine-rpm gt propulsion/engine[1]/backfiring-rpm-limit
                    <!-- too much fuel in engine (overprimed) -->
                    propulsion/engine[1]/fuel-available gt 5
                </test>
                <test logic="AND" value="1">
                    propulsion/engine[1]/has-spark gt 0
                    propulsion/engine[1]/fuel-available gt 0.1
                    propulsion/engine[1]/engine-rpm gt 30
                </test>
            </test>
        </switch>

        <fcs_function name="propulsion/engine[1]/backfiring-event">
            <function>
                <product>
                    <gt>
                        <product>
                            <sum>
                                <urandom/>
                                <v>1.0</v>
                            </sum>
                            <v>0.5</v>
                        </product>
                        <p>params/misc/backfiring-frequency</p>
                    </gt>
                    <p>propulsion/engine[1]/backfiring</p>
                </product>
            </function>
        </fcs_function>


        <switch name="propulsion/engine[1]/firing-state">
            <default value="0" />
            <!-- backfiring -->
            <test logic="OR" value="2">
                propulsion/engine[1]/backfiring gt 0
            </test>
            <test logic="AND" value="1">
                propulsion/engine[1]/has-spark gt 0
                propulsion/engine[1]/engine-rpm gt 30
                propulsion/engine[1]/fuel-available gt 0.1
            </test>
        </switch>

        <switch name="propulsion/engine[1]/power-hp-target">
            <default value="propulsion/engine[1]/power-hp-starter" />
            <test logic="OR" value="propulsion/engine[1]/power-hp-firing">
                propulsion/engine[1]/firing-state eq 1
            </test>
            <test logic="OR" value="propulsion/engine[1]/power-hp-backfiring">
                propulsion/engine[1]/firing-state eq 2
            </test>
        </switch>

        <pure_gain name="/engines/engine[1]/mp-osi">
            <input>propulsion/engine[1]/mp-inhg</input>
            <gain>1</gain>
        </pure_gain>

        <fcs_function name="fcs/throttle-pos-norm[1]">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine[1]/power-hp-target</independentVar>
                    <tableData>
                        0  0
                     1200  1
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[1]/fuel-demand-firing">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine[1]/power-hp-firing</independentVar>
                    <tableData>
                         0   0.2
                       625   7.5
                      1200  15.0
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[1]/fuel-demand-cranking">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine[1]/engine-rpm</independentVar>
                    <tableData>
                         0   0.0
                        30   0.1
                      1000   1.0
                      3000   3.0
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <switch name="propulsion/engine[1]/fuel-demand">
            <default value="propulsion/engine[1]/fuel-demand-cranking"/>
            <test value="propulsion/engine[1]/fuel-demand-firing">
                propulsion/engine[1]/firing-state eq 1
            </test>
        </switch>

        <fcs_function name="propulsion/engine[1]/max-fuel-flow">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine[1]/engine-rpm</independentVar>
                    <tableData>
                          0   0.0
                        150   0.0
                        500   1.0
                       1000  10.0
                       2000  20.0
                       3000  30.0
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <pure_gain name="propulsion/engine[1]/fuel-flow-primer">
            <input>/controls/engines/engine[1]/primer</input>
            <gain>0.5</gain>
        </pure_gain>

        <fcs_function name="propulsion/engine[1]/fuel-flow">
            <function>
                <difference>
                    <sum>
                        <!-- fuel supply from carburetor -->
                        <min>
                            <table>
                                <independentVar lookup="row">propulsion/engine[1]/fuel-available</independentVar>
                                <tableData>
                                   0.0  30
                                   0.5   0
                                </tableData>
                            </table>
                            <p>propulsion/engine[1]/max-fuel-flow</p>
                        </min>
                        <p>propulsion/engine[1]/fuel-flow-primer</p>
                    </sum>
                    <!-- fuel out -->
                    <p>propulsion/engine[1]/fuel-demand</p>
                </difference>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine[1]/fuel-available">
            <function>
                <max>
                    <sum>
                        <p>propulsion/engine[1]/fuel-available</p>
                        <product>
                            <p>simulation/channel-dt</p>
                            <p>propulsion/engine[1]/fuel-flow</p>
                        </product>
                    </sum>
                    <v>0.0</v>
                </max>
            </function>
        </fcs_function>

    </channel>
</system>
